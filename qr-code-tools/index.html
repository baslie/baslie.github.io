<!DOCTYPE html>
<html lang="ru" itemscope itemtype="https://schema.org/WebApplication">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Tools - Онлайн сканер и генератор QR-кодов</title>
    <meta name="description" content="Бесплатный онлайн сканер QR-кодов. Сканируйте QR-коды с камеры, загружайте изображения или PDF файлы. Быстро, безопасно и удобно.">
    <meta name="keywords" content="QR код, сканер, генератор, онлайн, бесплатно, камера, PDF, изображения">
    <meta name="author" content="QR Code Tools">
    <meta name="robots" content="index, follow">
    <meta property="og:type" content="website">
    <meta property="og:title" content="QR Code Tools - Онлайн сканер и генератор QR-кодов">
    <meta property="og:description" content="Бесплатный онлайн сканер QR-кодов. Сканируйте QR-коды с камеры, загружайте изображения или PDF файлы.">
    <meta property="og:image" content="assets/images/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="QR Code Tools">
    <meta property="og:locale" content="ru_RU">
    <meta property="og:site_name" content="QR Code Tools">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="QR Code Tools">
    <meta property="twitter:description" content="Бесплатный онлайн сканер QR-кодов. Сканируйте QR-коды с камеры, загружайте изображения или PDF файлы.">
    <meta property="twitter:image" content="assets/images/twitter-image.jpg">
    <meta property="twitter:image:alt" content="QR Code Tools">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#222222">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta http-equiv="Expires" content="31536000">
    <meta http-equiv="Pragma" content="cache">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "QR Code Tools",
        "description": "Бесплатный онлайн сканер и генератор QR-кодов. Сканируйте QR-коды с камеры, загружайте изображения или PDF файлы.",
        "applicationCategory": "Utility",
        "operatingSystem": "Any",
        "browserRequirements": "Requires JavaScript. Requires HTML5.",
        "softwareVersion": "1.0",
        "dateCreated": "2024-01-01",
        "dateModified": "2024-07-06",
        "inLanguage": "ru",
        "isAccessibleForFree": true,
        "author": {
            "@type": "Organization",
            "name": "QR Code Tools"
        },
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "RUR"
        },
        "featureList": [
            "Сканирование QR-кодов с камеры",
            "Загрузка изображений для сканирования",
            "Поддержка PDF файлов",
            "Мгновенное распознавание",
            "Копирование результата",
            "Открытие ссылок"
        ]
    }
    </script>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preload" href="https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvl4jLazX3dA.woff2" as="font" type="font/woff2" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <style>
    :root {
        --font-base: 'Fira Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        --font-size-base: 16px;
        --color-text: #222;
        --color-bg: #fff;
        --color-muted: #f1f1f1;
        --color-accent: #222;
        --color-border: rgba(0, 0, 0, .15);
        --color-border-light: rgba(0, 0, 0, .4);
        --color-success: #28a745;
        --color-error: #dc3545;
        --color-warning: #ffc107;
        --spacing: 15px;
        --spacing-sm: 10px;
        --spacing-xs: 6px;
        --radius-lg: 12px;
        --radius-md: 8px;
        --radius-sm: 4px;
        --radius-pill: 100px;
        --header-height: 28px;
        --upload-height-desktop: 80px;
        --upload-height-mobile: 120px;
        --font-size-sm: 0.9rem;
        --font-size-xs: 0.85rem;
        --line-height-normal: 1.3;
        --line-height-relaxed: 1.4;
        --opacity-muted: 0.8;
        --opacity-disabled: 0.5;
        --easing: cubic-bezier(.4, 0, .2, 1);
        --transition: .3s var(--easing)
    }

    @media(prefers-color-scheme:dark) {
        :root {
            --color-text: #e5e5e5;
            --color-bg: #121212;
            --color-muted: #1e1e1e;
            --color-accent: #fff;
            --color-border: rgba(255, 255, 255, .15);
            --color-border-light: rgba(255, 255, 255, .4)
        }
    }

    @media(prefers-reduced-motion:reduce) {
        * {
            transition: none !important;
            animation: none !important
        }
    }

    *,
    *::before,
    *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0
    }

    html {
        line-height: 1.15;
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
        scroll-behavior: smooth
    }

    body,
    main,
    header,
    section,
    article,
    aside,
    footer,
    nav {
        display: block
    }

    img,
    svg {
        max-width: 100%;
        height: auto;
        vertical-align: middle
    }

    ul,
    ol {
        list-style: none
    }

    table {
        border-collapse: collapse;
        border-spacing: 0
    }

    input,
    button,
    textarea,
    select {
        font: inherit;
        color: inherit;
        background: none;
        border: 0
    }

    button {
        cursor: pointer;
        outline: none
    }

    body {
        font-family: var(--font-base);
        font-size: var(--font-size-base);
        line-height: 1;
        color: var(--color-text);
        background: var(--color-bg);
        height: 100vh;
        padding: var(--spacing);
        display: flex;
        flex-direction: column;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        box-sizing: border-box
    }

    .app-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing);
        gap: var(--spacing)
    }

    .logo img {
        height: var(--header-height);
        width: auto
    }

    .switcher-background {
        display: flex;
        align-items: center;
        background: var(--color-muted);
        border-radius: var(--radius-pill);
        padding: var(--spacing-xs);
        position: relative
    }

    .switcher-slider {
        position: absolute;
        top: var(--spacing-xs);
        left: 0;
        height: 26px;
        background: var(--color-accent);
        border-radius: var(--radius-pill);
        transition: transform var(--transition), width var(--transition);
        z-index: 10
    }

    .switcher-btn {
        flex: 1;
        height: 26px;
        padding: 0 12px;
        border-radius: var(--radius-pill);
        background: transparent;
        color: var(--color-text);
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        position: relative;
        z-index: 20;
        transition: color var(--transition);
        line-height: 1
    }

    .switcher-btn--active {
        color: var(--color-bg)
    }

    .main-layout {
        display: flex;
        gap: var(--spacing);
        flex: 1
    }

    .control-panel,
    .result-panel {
        flex: 1;
        display: flex;
        flex-direction: column
    }

    .upload-sections {
        display: flex;
        flex-direction: column;
        gap: var(--spacing);
        flex: 1
    }

    .upload-section {
        width: 100%;
        flex: 1;
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--spacing);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform var(--transition), background var(--transition);
        background: var(--color-bg);
        position: relative;
        overflow: hidden
    }

    .result-section {
        width: 100%;
        flex: 1;
        background: var(--color-muted);
        border-radius: var(--radius-md);
        padding: var(--spacing);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center
    }

    .result-text {
        color: var(--color-text);
        opacity: 0.8;
        white-space: nowrap;
        margin-bottom: var(--spacing-sm);
    }

    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0
    }

    @media screen and (max-width:768px) {
        body {
            padding: 10px;
            height: auto;
            min-height: 100vh
        }

        .main-layout {
            flex-direction: column;
            gap: 15px
        }
    }

    .upload-icon {
        margin-right: var(--spacing-sm);
        width: 40px;
        height: 30px;
        opacity: var(--opacity-muted);
        flex-shrink: 0
    }

    .upload-text {
        text-align: center
    }

    .photo-content {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        flex-direction: row
    }

    .photo-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: row
    }

    .photo-placeholder--hidden {
        display: none
    }

    #qr-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--radius-md);
        background: var(--color-text);
        z-index: 1;
        display: none
    }

    #qr-video.active {
        display: block !important
    }

    .camera-overlay {
        position: absolute;
        bottom: var(--spacing);
        left: 50%;
        transform: translateX(-50%);
        display: none;
        gap: 10px;
        z-index: 100
    }

    .camera-overlay.active {
        display: flex
    }

    .camera-btn {
        padding: 8px 16px;
        border-radius: var(--radius-pill);
        background: var(--color-accent);
        color: var(--color-bg);
        border: none;
        cursor: pointer;
        transition: opacity var(--transition);
        font-size: var(--font-size-sm)
    }

    .result-content {
        display: none
    }

    .result-content--visible {
        display: block;
        width: 100%
    }

    .result-data {
        background: var(--color-bg);
        border-radius: var(--radius-md);
        padding: var(--spacing);
        margin-bottom: var(--spacing);
        word-break: break-all;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.9rem;
        line-height: 1.4
    }

    .result-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap
    }

    .result-btn {
        padding: 10px 20px;
        border-radius: var(--radius-pill);
        background: var(--color-accent);
        color: var(--color-bg);
        border: none;
        cursor: pointer;
        transition: opacity var(--transition);
        font-size: 0.9rem
    }

    .result-btn:hover {
        opacity: 0.8
    }

    .result-btn--success {
        background: var(--color-success)
    }

    .result-icon {
        margin-bottom: var(--spacing-sm);
    }

    .status-message {
        position: fixed;
        top: var(--spacing);
        right: var(--spacing);
        padding: 12px var(--spacing);
        border-radius: var(--radius-md);
        color: var(--color-bg);
        font-size: 0.9rem;
        z-index: 9999;
        transform: translateX(100%);
        transition: transform var(--transition);
        max-width: 300px;
        word-wrap: break-word
    }

    .status-message--visible {
        transform: translateX(0)
    }

    .status-message--success {
        background: var(--color-success)
    }

    .status-message--error {
        background: var(--color-error)
    }

    .status-message--warning {
        background: var(--color-warning);
        color: var(--color-text)
    }

    .loading {
        display: none;
        margin-top: 10px
    }

    .loading--visible {
        display: block
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--color-border);
        border-top: 2px solid var(--color-accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg)
        }

        100% {
            transform: rotate(360deg)
        }
    }

    .skip-to-main {
        position: absolute;
        top: -40px;
        left: 6px;
        background: var(--color-accent);
        color: var(--color-bg);
        padding: 8px;
        text-decoration: none;
        z-index: 9998;
        border-radius: var(--radius-sm);
        font-size: 14px;
        transition: top var(--transition)
    }

    .skip-to-main:focus {
        top: 6px
    }

    button:focus,
    input:focus {
        outline: 2px solid var(--color-accent);
        outline-offset: 2px
    }

    .pdf-canvas {
        display: none
    }
    </style>
</head>

<body>
    <a href="#main-content" class="skip-to-main" aria-label="Перейти к основному содержимому">Перейти к содержимому</a>
    <div class="app-container">
        <header class="header" role="banner">
            <div class="logo">
                <img src="assets/images/qr-code-tools-logo.svg" alt="QR Code Tools - логотип приложения" width="192" height="28" loading="eager" fetchpriority="high">
            </div>
            <nav class="switcher" role="navigation" aria-label="Переключение между функциями">
                <div class="switcher-background">
                    <div class="switcher-slider" aria-hidden="true"></div>
                    <button class="switcher-btn switcher-btn--active" data-tab="scanner" aria-pressed="true" aria-describedby="scanner-description">Сканер</button>
                    <button class="switcher-btn" data-tab="generator" aria-pressed="false" aria-describedby="generator-description">Генератор</button>
                </div>
                <div id="scanner-description" class="sr-only">Сканирование QR-кодов с камеры или файлов</div>
                <div id="generator-description" class="sr-only">Создание QR-кодов из текста или ссылок</div>
            </nav>
        </header>
        <main class="main-content" id="main-content" role="main">
            <h1 class="sr-only">QR Code Scanner - Сканер QR-кодов</h1>
            <div class="main-layout">
                <section class="control-panel" aria-labelledby="control-heading">
                    <h2 id="control-heading" class="sr-only">Способы сканирования QR-кода</h2>
                    <div class="upload-sections">
                        <div class="upload-section upload-section--photo" id="camera-btn" role="button" tabindex="0" aria-label="Использовать камеру для сканирования QR-кода">
                            <div class="photo-content" id="photo-content">
                                <div class="photo-placeholder" id="photo-placeholder">
                                    <img src="assets/images/photo.svg" alt="" class="upload-icon upload-icon--photo" width="40" height="30" aria-hidden="true" loading="lazy">
                                    <span class="upload-text">Сделать фото</span>
                                </div>
                                <video id="qr-video" autoplay muted playsinline aria-label="Видеопоток с камеры для сканирования QR-кода"></video>
                                <div class="camera-overlay" id="camera-overlay" role="group" aria-label="Управление камерой">
                                    <button class="camera-btn" id="stop-scan-btn" aria-describedby="stop-scan-desc">Остановить</button>
                                </div>
                                <div id="stop-scan-desc" class="sr-only">Остановить сканирование и закрыть камеру</div>
                                <div class="loading" id="camera-loading" aria-live="polite" aria-label="Загрузка камеры">
                                    <div class="loading-spinner" aria-hidden="true"></div>
                                    <span class="sr-only">Инициализация камеры...</span>
                                </div>
                            </div>
                        </div>
                        <label class="upload-section upload-section--upload" for="file-input" id="file-upload-btn" aria-describedby="file-upload-desc">
                            <img src="assets/images/upload.svg" alt="" class="upload-icon upload-icon--upload" width="32" height="30" aria-hidden="true" loading="lazy">
                            <span class="upload-text">Загрузить изображение</span>
                            <input type="file" id="file-input" class="file-input" accept="image/*,.pdf,.gif" multiple aria-describedby="file-upload-desc">
                            <div id="file-upload-desc" class="sr-only">Выберите изображения или PDF файлы для сканирования QR-кодов</div>
                            <div class="loading" id="upload-loading" aria-live="polite" aria-label="Обработка файла">
                                <div class="loading-spinner" aria-hidden="true"></div>
                                <span class="sr-only">Обработка файла...</span>
                            </div>
                        </label>
                    </div>
                </section>
                <section class="result-panel" aria-labelledby="result-heading">
                    <h2 id="result-heading" class="sr-only">Результат сканирования</h2>
                    <div class="result-section" id="result-section" role="region" aria-live="polite" aria-labelledby="result-text">
                        <img src="assets/images/qr-result.svg" alt="" class="result-icon" id="result-icon" width="40" height="40" aria-hidden="true" loading="lazy">
                        <span class="result-text" id="result-text">Результат сканирования</span>
                        <div class="result-content" id="result-content">
                            <div class="result-data" id="result-data" role="textbox" aria-readonly="true" aria-label="Содержимое QR-кода"></div>
                            <div class="result-actions" role="group" aria-label="Действия с результатом">
                                <button class="result-btn" id="copy-btn" aria-describedby="copy-desc">Копировать</button>
                                <button class="result-btn" id="open-link-btn" style="display: none;" aria-describedby="open-link-desc">Открыть ссылку</button>
                                <button class="result-btn" id="clear-btn" aria-describedby="clear-desc">Очистить</button>
                            </div>
                            <div id="copy-desc" class="sr-only">Скопировать результат в буфер обмена</div>
                            <div id="open-link-desc" class="sr-only">Открыть ссылку в новой вкладке</div>
                            <div id="clear-desc" class="sr-only">Очистить результат сканирования</div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <canvas id="pdf-canvas" class="pdf-canvas"></canvas>
    <script>
    // Регистрация Service Worker для кэширования
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('Service Worker зарегистрирован:', registration.scope);
                })
                .catch((error) => {
                    console.log('Ошибка регистрации Service Worker:', error);
                });
        });
    }
    
    class L {
        constructor() {
            this.loaded = new Set();
            this.loading = new Map()
        }
        async loadScript(u, n) {
            if (this.loaded.has(n)) return;
            if (this.loading.has(n)) return this.loading.get(n);
            const p = new Promise((r, e) => {
                const s = document.createElement('script');
                s.src = u;
                s.onload = () => {
                    this.loaded.add(n);
                    r()
                };
                s.onerror = () => e(new Error(`Failed to load ${n}`));
                document.head.appendChild(s)
            });
            this.loading.set(n, p);
            return p
        }
        async loadJsQR() {
            await this.loadScript('https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js', 'jsQR');
            return typeof jsQR !== 'undefined'
        }
        async loadPDFjs() {
            await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js', 'pdfjs');
            return typeof pdfjsLib !== 'undefined'
        }
    }
    class Q {
        constructor() {
            this.scanner = null;
            this.isScanning = false;
            this.lastScannedCode = null;
            this.lastScanTime = null;
            this.loader = new L();
            this.initElements();
            this.initEventListeners();
            this.initSlider();
            this.checkCameraSupport()
        }
        initElements() {
            this.cameraBtn = document.getElementById('camera-btn');
            this.fileInput = document.getElementById('file-input');
            this.video = document.getElementById('qr-video');
            this.photoPlaceholder = document.getElementById('photo-placeholder');
            this.cameraOverlay = document.getElementById('camera-overlay');
            this.stopScanBtn = document.getElementById('stop-scan-btn');
            this.cameraLoading = document.getElementById('camera-loading');
            this.uploadLoading = document.getElementById('upload-loading');
            this.resultContent = document.getElementById('result-content');
            this.resultData = document.getElementById('result-data');
            this.resultText = document.getElementById('result-text');
            this.copyBtn = document.getElementById('copy-btn');
            this.openLinkBtn = document.getElementById('open-link-btn');
            this.clearBtn = document.getElementById('clear-btn');
            this.pdfCanvas = document.getElementById('pdf-canvas')
        }
        initEventListeners() {
            this.cameraBtn.addEventListener('click', () => this.toggleCamera());
            this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
            this.stopScanBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.stopScanning()
            });
            this.copyBtn.addEventListener('click', () => this.copyResult());
            this.openLinkBtn.addEventListener('click', () => this.openLink());
            this.clearBtn.addEventListener('click', () => this.clearResult())
        }
        async checkCameraSupport() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.cameraBtn.style.opacity = '0.5';
                    this.cameraBtn.style.cursor = 'not-allowed';
                    this.showStatus('Камера недоступна', 'warning')
                }
            } catch (e) {
                this.cameraBtn.style.opacity = '0.5'
            }
        }
        async toggleCamera() {
            if (!this.video.classList.contains('active')) {
                this.showCamera()
            } else {
                this.hideCamera()
            }
        }
        async showCamera() {
            try {
                this.showLoading();
                if (!this.loader.loaded.has('jsQR')) {
                    this.showStatus('Загрузка библиотеки...', 'warning')
                }
                await this.loader.loadJsQR();
                await this.initScanner();
                this.photoPlaceholder.classList.add('photo-placeholder--hidden');
                this.video.classList.add('active');
                this.cameraOverlay.classList.add('active');
                this.isScanning = true;
                this.startScanning();
                this.hideLoading();
                this.showStatus('Камера активирована', 'success')
            } catch (e) {
                this.showStatus('Ошибка камеры: ' + e.message, 'error');
                this.hideLoading();
                this.hideCamera()
            }
        }
        hideCamera() {
            if (this.video.srcObject) {
                this.video.srcObject.getTracks().forEach(t => t.stop());
                this.video.srcObject = null
            }
            this.photoPlaceholder.classList.remove('photo-placeholder--hidden');
            this.video.classList.remove('active');
            this.cameraOverlay.classList.remove('active');
            this.isScanning = false;
            this.scanCanvas = null;
            this.scanContext = null
        }
        async initScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment'
                    }
                });
                this.video.srcObject = stream;
                this.video.play();
                this.scanCanvas = document.createElement('canvas');
                this.scanContext = this.scanCanvas.getContext('2d', {
                    willReadFrequently: true
                });
                await new Promise((r) => {
                    this.video.addEventListener('loadedmetadata', () => r())
                })
            } catch (e) {
                throw e
            }
        }
        startScanning() {
            let frameSkip = 0;
            const scan = () => {
                if (this.isScanning && this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
                    frameSkip++;
                    if (frameSkip % 3 !== 0) {
                        requestAnimationFrame(scan);
                        return
                    }
                    this.scanCanvas.height = this.video.videoHeight;
                    this.scanCanvas.width = this.video.videoWidth;
                    if (this.scanCanvas.width > 0 && this.scanCanvas.height > 0) {
                        this.scanContext.drawImage(this.video, 0, 0, this.scanCanvas.width, this.scanCanvas.height);
                        const centerSize = Math.min(this.scanCanvas.width, this.scanCanvas.height) * 0.7;
                        const centerX = (this.scanCanvas.width - centerSize) / 2;
                        const centerY = (this.scanCanvas.height - centerSize) / 2;
                        let imageData = this.scanContext.getImageData(centerX, centerY, centerSize, centerSize);
                        let code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth"
                        });
                        if (!code || !code.data || code.data.trim() === '') {
                            imageData = this.scanContext.getImageData(0, 0, this.scanCanvas.width, this.scanCanvas.height);
                            code = jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "attemptBoth"
                            })
                        }
                        if (code && code.data && code.data.trim() !== '') {
                            if (this.lastScannedCode !== code.data || !this.lastScanTime || Date.now() - this.lastScanTime > 3000) {
                                this.lastScannedCode = code.data;
                                this.lastScanTime = Date.now();
                                this.handleScanResult({
                                    data: code.data
                                })
                            }
                            return
                        }
                    }
                }
                if (this.isScanning) {
                    requestAnimationFrame(scan)
                }
            };
            requestAnimationFrame(scan)
        }
        stopScanning() {
            this.hideCamera();
            this.showStatus('Камера остановлена', 'warning')
        }
        async handleFileUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            this.showUploadLoading();
            for (const file of files) {
                try {
                    await this.processFile(file)
                } catch (error) {
                    this.showStatus(`Ошибка файла ${file.name}: ${error.message}`, 'error')
                }
            }
            this.hideUploadLoading();
            e.target.value = ''
        }
        async processFile(file) {
            const fileType = file.type.toLowerCase();
            const fileName = file.name.toLowerCase();
            if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
                const needsPDF = !this.loader.loaded.has('pdfjs');
                const needsJsQR = !this.loader.loaded.has('jsQR');
                if (needsPDF || needsJsQR) {
                    this.showStatus('Загрузка библиотек для PDF...', 'warning')
                }
                await Promise.all([this.loader.loadPDFjs(), this.loader.loadJsQR()]);
                await this.processPDF(file)
            } else if (fileType.startsWith('image/') || this.isImageFile(fileName)) {
                if (!this.loader.loaded.has('jsQR')) {
                    this.showStatus('Загрузка библиотеки...', 'warning')
                }
                await this.loader.loadJsQR();
                await this.processImage(file)
            } else {
                throw new Error('Неподдерживаемый тип файла')
            }
        }
        isImageFile(fileName) {
            const exts = ['.jpg', '.jpeg', '.png', '.bmp', '.webp', '.svg', '.gif'];
            return exts.some(ext => fileName.endsWith(ext))
        }
        async processImage(file) {
            try {
                const result = await this.scanWithJsQR(file);
                this.showResult(result);
                this.showStatus(`QR-код найден в ${file.name}`, 'success')
            } catch (e) {
                throw new Error(`QR-код не найден в ${file.name}`)
            }
        }
        async scanWithJsQR(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const objectUrl = URL.createObjectURL(file);
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    URL.revokeObjectURL(objectUrl);
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d', {
                            willReadFrequently: true
                        });
                        const scale = Math.max(1, Math.min(3, 800 / Math.max(img.width, img.height)));
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const attempts = [() => {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            this.convertToBlackWhite(imageData.data);
                            return jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "attemptBoth"
                            })
                        }, () => {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            return jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "attemptBoth"
                            })
                        }, () => {
                            const hCanvas = document.createElement('canvas');
                            const hCtx = hCanvas.getContext('2d', {
                                willReadFrequently: true
                            });
                            const hScale = 3;
                            hCanvas.width = img.width * hScale;
                            hCanvas.height = img.height * hScale;
                            hCtx.imageSmoothingEnabled = false;
                            hCtx.drawImage(img, 0, 0, hCanvas.width, hCanvas.height);
                            const imageData = hCtx.getImageData(0, 0, hCanvas.width, hCanvas.height);
                            this.convertToBlackWhite(imageData.data);
                            return jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "attemptBoth"
                            })
                        }];
                        for (let i = 0; i < attempts.length; i++) {
                            const code = attempts[i]();
                            if (code && code.data && code.data.trim() !== '') {
                                resolve(code.data);
                                return
                            }
                        }
                        reject(new Error('No QR code found'))
                    } catch (e) {
                        reject(new Error('Failed to process: ' + e.message))
                    }
                };
                img.onerror = () => {
                    URL.revokeObjectURL(objectUrl);
                    reject(new Error('Failed to load image'))
                };
                img.src = objectUrl
            })
        }
        convertToBlackWhite(data) {
            const threshold = 128;
            for (let i = 0; i < data.length; i += 4) {
                const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                const bw = gray < threshold ? 0 : 255;
                data[i] = bw;
                data[i + 1] = bw;
                data[i + 2] = bw
            }
        }
        async processPDF(file) {
            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({
                    data: arrayBuffer
                }).promise;
                let qrFound = false;
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    try {
                        const page = await pdf.getPage(pageNum);
                        const canvas = await this.renderPDFPage(page);
                        const ctx = canvas.getContext('2d');
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth"
                        });
                        if (code) {
                            this.showResult(code.data);
                            this.showStatus(`QR-код найден на стр. ${pageNum}`, 'success');
                            qrFound = true;
                            break
                        }
                    } catch (e) {}
                }
                if (!qrFound) {
                    throw new Error(`QR-код не найден в PDF ${file.name}`)
                }
            } catch (e) {
                throw new Error(`Ошибка PDF: ${e.message}`)
            }
        }
        async renderPDFPage(page) {
            const scale = 2.0;
            const viewport = page.getViewport({
                scale
            });
            const canvas = this.pdfCanvas;
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;
            return canvas
        }
        showResult(data) {
            this.resultData.textContent = data;
            this.resultText.textContent = 'QR-код распознан:';
            this.resultContent.classList.add('result-content--visible');
            this.updateOpenLinkButton(data)
        }
        updateOpenLinkButton(data) {
            const urlPattern = /^(https?:\/\/|www\.)/i;
            if (urlPattern.test(data)) {
                this.openLinkBtn.style.display = 'block';
                this.openLinkBtn.onclick = () => {
                    const url = data.startsWith('http') ? data : 'https://' + data;
                    window.open(url, '_blank')
                }
            } else {
                this.openLinkBtn.style.display = 'none'
            }
        }
        async copyResult() {
            try {
                await navigator.clipboard.writeText(this.resultData.textContent);
                this.showStatus('Скопировано', 'success')
            } catch (e) {
                this.showStatus('Ошибка копирования', 'error')
            }
        }
        openLink() {
            const data = this.resultData.textContent;
            const url = data.startsWith('http') ? data : 'https://' + data;
            window.open(url, '_blank')
        }
        clearResult() {
            this.resultContent.classList.remove('result-content--visible');
            this.resultText.textContent = 'Результат сканирования';
            this.resultData.textContent = '';
            this.lastScannedCode = null;
            this.lastScanTime = null;
            if (this.video.classList.contains('active') && !this.isScanning) {
                this.isScanning = true;
                this.startScanning()
            }
        }
        handleScanResult(result) {
            const qrData = result.data || result;
            this.showResult(qrData);
            this.showStatus('QR-код распознан!', 'success');
            this.pauseScanningTemporarily()
        }
        pauseScanningTemporarily() {
            this.isScanning = false;
            setTimeout(() => {
                if (this.video.classList.contains('active')) {
                    this.isScanning = true;
                    this.startScanning()
                }
            }, 2000)
        }
        showLoading() {
            this.cameraLoading.classList.add('loading--visible')
        }
        hideLoading() {
            this.cameraLoading.classList.remove('loading--visible')
        }
        showUploadLoading() {
            this.uploadLoading.classList.add('loading--visible')
        }
        hideUploadLoading() {
            this.uploadLoading.classList.remove('loading--visible')
        }
        showStatus(message, type = 'success') {
            const existing = document.querySelectorAll('.status-message');
            existing.forEach(msg => msg.remove());
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-message--${type}`;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => {
                statusDiv.classList.add('status-message--visible')
            }, 10);
            setTimeout(() => {
                statusDiv.classList.remove('status-message--visible');
                setTimeout(() => statusDiv.remove(), 300)
            }, 3000)
        }
        initSlider() {
            const buttons = document.querySelectorAll('.switcher-btn');
            const slider = document.querySelector('.switcher-slider');
            const activeClass = 'switcher-btn--active';

            function moveSlider(btn) {
                slider.style.width = `${btn.offsetWidth}px`;
                slider.style.transform = `translateX(${btn.offsetLeft}px)`
            }
            moveSlider(document.querySelector(`.${activeClass}`));
            buttons.forEach(btn => btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove(activeClass));
                btn.classList.add(activeClass);
                moveSlider(btn);
                if (btn.dataset.tab === 'generator') {
                    this.showStatus('Генератор будет добавлен позже', 'warning')
                }
            }))
        }
        destroy() {
            if (this.scanner) {
                this.scanner.destroy();
                this.scanner = null
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const qrApp = new Q();
            window.addEventListener('beforeunload', () => {
                qrApp.destroy()
            })
        } catch (e) {
            document.body.innerHTML = '<div style="padding:20px;text-align:center;color:red;">Ошибка загрузки. Обновите страницу.</div>'
        }
    });
    </script>
</body>

</html>